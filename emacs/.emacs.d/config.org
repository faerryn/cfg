#+TITLE: Faerryn's Emacs Config
#+STARTUP: indent overview

* Lexical Binding
#+begin_src emacs-lisp
  ;;; config.el -*- lexical-binding: t; -*-
#+end_src
* Straight.el
Straight.el is a declarative package manager for Emacs.
#+begin_src emacs-lisp
  (custom-set-variables
   '(straight-check-for-modifications '(find-when-checking))
   '(straight-disable-autoloads t)
   '(straight-use-symlinks t)
   '(straight-vc-git-default-clone-depth 1))
  (let ((dest (expand-file-name "straight/repos/straight.el/" user-emacs-directory))
        (repo "https://github.com/raxod502/straight.el.git"))
    (unless (file-directory-p dest)
      (call-process "git" nil nil nil "clone" "--depth" "1" repo dest))
    (require 'straight (expand-file-name "straight.el" dest))
    (with-temp-buffer
      (insert-file-contents (expand-file-name "bootstrap.el" dest))
      (eval-region (search-forward "(require 'straight)")
                   (point-max))))
#+end_src
* Custom Symbols
#+begin_src emacs-lisp
  (defvar faerryn/before-minibuffer-hook nil
    "Normal hook run just before entry to minibuffer")
  (defun faerryn/run-before-minibuffer-hooks (&rest ignored)
    (run-hooks 'faerryn/before-minibuffer-hook))
  (advice-add #'read-from-minibuffer :before #'faerryn/run-before-minibuffer-hooks)
  (advice-add #'read-no-blanks-input :before #'faerryn/run-before-minibuffer-hooks)
  (advice-add #'read-string :before #'faerryn/run-before-minibuffer-hooks)
#+end_src
* Appearance
** Modeline
#+begin_src emacs-lisp
  (display-time-mode +1)
  (display-battery-mode +1)
  (straight-use-package 'doom-modeline)
  (require 'doom-modeline)
  (custom-set-variables '(doom-modeline-icon t))
  (doom-modeline-mode +1)
#+end_src
** Tab Bar
Like vim tabs.
#+begin_src emacs-lisp
  (custom-set-variables
   '(tab-bar-mode t)
   '(tab-bar-close-button nil)
   '(tab-bar-new-button nil))
#+end_src
** Theme
#+begin_src emacs-lisp
  (straight-use-package 'doom-themes)
  (require 'doom-themes)
  (load-theme 'doom-one t)
#+end_src
* Editor
** Electric Pairs
#+begin_src emacs-lisp
  (electric-pair-mode +1)
#+end_src
** Tab Complete
#+begin_src emacs-lisp
  (custom-set-variables '(tab-always-indent 'complete))
#+end_src
* Visual Aids
** Line Numbers
#+begin_src emacs-lisp
  (custom-set-variables '(display-line-numbers-type t))
  (global-display-line-numbers-mode +1)
#+end_src
** Show Paren
#+begin_src emacs-lisp
  (show-paren-mode +1)
#+end_src
** Whitespace
#+begin_src emacs-lisp
  (custom-set-variables '(whitespace-style '(face tabs trailing tab-mark)))
  (global-whitespace-mode +1)
#+end_src
* Hated Things
** Buffers
#+begin_src emacs-lisp
  (custom-set-variables '(async-shell-command-buffer 'new-buffer))
  (let ((async-shell-command-regexp (rx string-start "*Async Shell Command*" (? "<" (+ digit) ">"))))
    (add-to-list 'display-buffer-alist `(,async-shell-command-regexp display-buffer-no-window allow-no-window))
    (with-eval-after-load "consult"
      (add-to-list 'consult-buffer-filter async-shell-command-regexp)))
  (with-eval-after-load "consult"
    (add-to-list 'consult-buffer-filter (rx string-start "*" (or "Backtrace" "Help" "Messages") "*" string-end))
    (add-to-list 'consult-buffer-filter (rx string-start "*" (or (seq "changes to " (* anychar) "/") "log-edit-files" "vc" "vc-dir") "*" string-end))
    (add-to-list 'consult-buffer-filter (rx string-start "magit" (or "-diff" "-process" "-revision" "") ": "))
    (add-to-list 'consult-buffer-filter (rx string-start "*straight" (or "-byte-compilation" "-process") "*" string-end)))
#+end_src
** Line Wrap
#+begin_src emacs-lisp
  (custom-set-variables '(truncate-lines t))
#+end_src
** Widgets
#+begin_src emacs-lisp
  (custom-set-variables
   '(inhibit-startup-screen t)
   '(use-dialog-box nil))
  (menu-bar-mode -1)
  (tool-bar-mode -1)
  (scroll-bar-mode -1)
#+end_src
* Major Modes
** Cc Mode
#+begin_src emacs-lisp
  (with-eval-after-load "cc-mode"
    (advice-add 'c-indent-command :override #'indent-for-tab-command))
#+end_src
** Dired Mode
#+begin_src emacs-lisp
  (custom-set-variables '(dired-listing-switches "-AFhlvX --group-directories-first"))
  (require 'dired-x)
#+end_src
* Minibuffer
** Consult
#+begin_src emacs-lisp
  (straight-use-package 'consult)
  (autoload 'consult-completion-in-region "consult" "Prompt for completion of region in the minibuffer if non-unique.")
  (advice-add 'completion-in-region :override #'consult-completion-in-region)
  (autoload 'consult-buffer "consult" "Enhanced ‘switch-to-buffer’ command with support for virtual buffers." t)
  (define-key (current-global-map) (kbd "C-c b") #'consult-buffer)
  (autoload 'consult-buffer-other-frame "consult" "Variant of ‘consult-buffer’ which opens in other frame." t)
  (define-key (current-global-map) (kbd "C-c 5 b") #'consult-buffer-other-frame)
  (autoload 'consult-buffer-other-window "consult" "Variant of ‘consult-buffer’ which opens in other window." t)
  (define-key (current-global-map) (kbd "C-c 4 b") #'consult-buffer-other-window)
#+end_src
** Marginalia
#+begin_src emacs-lisp
  (straight-use-package 'marginalia)
  (require 'marginalia)
  (marginalia-mode +1)
#+end_src
** Orderless
Smarter sorting in completion buffers.
#+begin_src emacs-lisp
  (straight-use-package 'orderless)
  (require 'orderless)
  (custom-set-variables
   '(completion-styles '(orderless))
   '(completion-category-defaults nil)
   '(completion-category-overrides '((file (styles partial-completion)))))
#+end_src
** Vertico
Minimal and compatible completion framework.
#+begin_src emacs-lisp
  (straight-use-package
   `(vertico :files ,(cons "extensions/*.el" straight-default-files-directive)))
  (require 'vertico)
  (require 'vertico-mouse)
  (vertico-mode +1)
  (vertico-mouse-mode +1)
#+end_src
* Text Terminal
** Xterm Mouse
#+begin_src emacs-lisp
  (add-hook 'tty-setup-hook #'xterm-mouse-mode)
#+end_src
** Xclip
#+begin_src emacs-lisp
  (straight-use-package 'xclip)
  (autoload 'xclip-mode "xclip" "Minor mode to use the `xclip' program to copy&paste." t)
  (add-hook 'tty-setup-hook #'xclip-mode)
#+end_src
* Define Keys
#+begin_src emacs-lisp
  (define-key (current-global-map) (kbd "C-c f") #'fixup-whitespace)
#+end_src
* EXWM
#+begin_src emacs-lisp
  (straight-use-package 'exwm)
  (autoload 'exwm-init "exwm" "Initialize EXWM." t)
  (with-eval-after-load "exwm"
    (custom-set-variables
     '(exwm-mode-map
       (let ((map (make-sparse-keymap)))
         (define-key map (kbd "C-q") #'exwm-input-send-next-key)
         (define-key map (kbd "C-c f") #'exwm-layout-toggle-fullscreen)
         (define-key map (kbd "C-c SPC") #'exwm-floating-toggle-floating)
         map))
     '(exwm-input-prefix-keys
       (list (kbd "C-g")
             (kbd "C-h")
             (kbd "C-u")
             (kbd "C-x")
             (kbd "M-x")
             (kbd "M-!")
             (kbd "M-&")
             (kbd "M-:")))
     '(exwm-input-simulation-keys
       `((,(kbd "C-y") . ,(kbd "C-v"))
         (,(kbd "C-w") . ,(kbd "C-x"))
         (,(kbd "M-w") . ,(kbd "C-c"))
         (,(kbd "C-f") . ,(kbd "<right>"))
         (,(kbd "C-p") . ,(kbd "<up>"))
         (,(kbd "C-b") . ,(kbd "<left>"))
         (,(kbd "C-n") . ,(kbd "<down>"))
         (,(kbd "C-a") . ,(kbd "<home>"))
         (,(kbd "C-e") . ,(kbd "<end>")))))
    (defun faerryn/exwm-buffer-local-name ()
      (exwm-workspace-rename-buffer (concat "*EXWM* " exwm-class-name)))
    (add-hook 'exwm-update-class-hook #'faerryn/exwm-buffer-local-name)
    (defun faerryn/exwm-buffer-local-simulation-keys ()
      (pcase exwm-class-name
        ("Firefox" (exwm-input-set-local-simulation-keys
                    (append `((,(kbd "C-s") . ,(kbd "C-f"))
                              (,(kbd "C-c 0") . ,(kbd "C-w"))
                              (,(kbd "C-c 2") . ,(kbd "C-t"))
                              (,(kbd "C-c o") . ,(kbd "C-<tab>")))
                            exwm-input-simulation-keys)))))
    (add-hook 'exwm-update-class-hook #'faerryn/exwm-buffer-local-simulation-keys)
    (defun faerryn/exwm-restore-mode (&rest ignored)
      (when (eq 'line-mode exwm--selected-input-mode)
        (exwm-input--grab-keyboard exwm--id)))
    (advice-add #'exwm-layout-set-fullscreen :after #'faerryn/exwm-restore-mode)
    (add-hook 'exwm-init-hook
              (lambda ()
                (add-hook 'faerryn/before-minibuffer-hook #'exwm-layout-unset-fullscreen)
                (add-hook 'window-state-change-hook #'exwm-layout-unset-fullscreen)))
    (add-hook 'exwm-exit-hook
              (lambda ()
                (remove-hook 'faerryn/before-minibuffer-hook #'exwm-layout-unset-fullscreen)
                (remove-hook 'window-state-change-hook #'exwm-layout-unset-fullscreen))))
#+end_src
* GCMH
GCMH is an intelligent garbage collector scheduler for Emacs.
#+begin_src emacs-lisp
  (straight-use-package 'gcmh)
  (require 'gcmh)
  (add-hook 'emacs-startup-hook #'gcmh-mode)
#+end_src
* Follow Symlinks
#+begin_src emacs-lisp
  (custom-set-variables
   '(find-file-visit-truename t)
   '(vc-follow-symlinks t))
#+end_src
* Magit
#+begin_src emacs-lisp
  (straight-use-package 'magit)
  (custom-set-variables '(magit-define-global-key-bindings nil))
  (autoload 'magit-status "magit" "Show the status of the current Git repository in a buffer." t)
  (define-key (current-global-map) (kbd "C-c g") #'magit-status)
#+end_src
